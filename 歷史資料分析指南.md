# 📊 歷史資料分析指南

## ✅ 您已擁有的資料

### 資料內容
每筆記錄包含：
- 📅 **日期時間**
- 💰 **收盤價**
- 📊 **財務指標**: EPS, PE, PB, ROE, 殖利率, 負債比等

## 🛠️ 分析工具使用

### 1️⃣ 互動式查詢工具（最簡單）

```bash
# 執行互動式查詢
python3 query_stock.py
```

**7 種分析功能**：
1. 查看最新資料（所有股票）
2. 查看特定股票歷史
3. 查看更新日誌
4. 查看資料庫統計
5. 匯出特定股票 CSV
6. 比較股票表現
7. 查看價格趨勢 ⭐

### 2️⃣ SQL 直接查詢（最靈活）

```bash
# 進入 SQLite 命令列
sqlite3 stock_history.db
```

#### 常用查詢範例

##### 📈 查看特定股票完整歷史
```sql
SELECT 
    date(fetch_time) as 日期,
    price as 收盤價,
    pe as 本益比,
    roe as ROE
FROM stock_history
WHERE ticker = '2480'
ORDER BY fetch_time DESC
LIMIT 30;
```

##### 📊 月線資料
```sql
SELECT 
    strftime('%Y-%m', fetch_time) as 月份,
    ROUND(AVG(price), 2) as 平均價,
    ROUND(MIN(price), 2) as 最低價,
    ROUND(MAX(price), 2) as 最高價,
    COUNT(*) as 交易日數
FROM stock_history
WHERE ticker = '2480'
GROUP BY strftime('%Y-%m', fetch_time)
ORDER BY 月份;
```

##### 🏆 找出本益比最低的股票
```sql
SELECT 
    ticker,
    name,
    ROUND(AVG(price), 2) as 平均價,
    ROUND(AVG(pe), 2) as 平均本益比,
    ROUND(AVG(roe), 2) as 平均ROE
FROM stock_history
WHERE pe > 0  -- 排除異常值
GROUP BY ticker, name
ORDER BY 平均本益比 ASC
LIMIT 10;
```

##### 📉 找出近期下跌的股票（買入機會？）
```sql
WITH recent_price AS (
    SELECT 
        ticker,
        name,
        price,
        ROW_NUMBER() OVER (PARTITION BY ticker ORDER BY fetch_time DESC) as rn
    FROM stock_history
)
SELECT 
    a.ticker,
    a.name,
    ROUND(b.price, 2) as 一個月前,
    ROUND(a.price, 2) as 最新價,
    ROUND((a.price - b.price) / b.price * 100, 2) as 月漲跌幅
FROM recent_price a
JOIN recent_price b ON a.ticker = b.ticker
WHERE a.rn = 1 AND b.rn = 22  -- 約一個月（22個交易日）
ORDER BY 月漲跌幅 ASC
LIMIT 10;
```

##### 📊 產業平均表現
```sql
SELECT 
    sector as 產業,
    COUNT(DISTINCT ticker) as 股票數,
    ROUND(AVG(price), 2) as 平均股價,
    ROUND(AVG(pe), 2) as 平均本益比,
    ROUND(AVG(roe), 2) as 平均ROE
FROM stock_history
WHERE date(fetch_time) = (SELECT MAX(date(fetch_time)) FROM stock_history)
GROUP BY sector
ORDER BY 平均ROE DESC;
```

##### 🎯 巴菲特式選股（高ROE、低本益比）
```sql
SELECT 
    ticker,
    name,
    ROUND(AVG(price), 2) as 平均價,
    ROUND(AVG(pe), 2) as 平均本益比,
    ROUND(AVG(roe), 2) as 平均ROE,
    ROUND(AVG(dividend_yield), 2) as 平均殖利率
FROM stock_history
WHERE pe > 0 AND roe > 0
GROUP BY ticker, name
HAVING 平均ROE >= 15 AND 平均本益比 <= 15
ORDER BY 平均ROE DESC;
```

##### 📈 計算移動平均線（MA）
```sql
-- 2480 敦陽科技的 5 日移動平均
SELECT 
    date(fetch_time) as 日期,
    ROUND(price, 2) as 收盤價,
    ROUND(AVG(price) OVER (
        ORDER BY fetch_time 
        ROWS BETWEEN 4 PRECEDING AND CURRENT ROW
    ), 2) as MA5
FROM stock_history
WHERE ticker = '2480'
ORDER BY fetch_time DESC
LIMIT 30;
```

### 3️⃣ 匯出資料到 Excel 分析

```bash
# 匯出特定股票完整歷史
sqlite3 -header -csv stock_history.db \
  "SELECT * FROM stock_history WHERE ticker = '2480' ORDER BY fetch_time" \
  > 敦陽科技_歷史.csv

# 匯出所有股票最新資料
sqlite3 -header -csv stock_history.db \
  "SELECT * FROM stock_history 
   WHERE date(fetch_time) = (SELECT MAX(date(fetch_time)) FROM stock_history)" \
  > 最新股票資料.csv

# 匯出年度報酬率統計
sqlite3 -header -csv stock_history.db << 'EOF' > 年度報酬率.csv
WITH first_last AS (
    SELECT 
        ticker, name,
        FIRST_VALUE(price) OVER (PARTITION BY ticker ORDER BY fetch_time ASC) as 年初價,
        FIRST_VALUE(price) OVER (PARTITION BY ticker ORDER BY fetch_time DESC) as 年末價
    FROM stock_history
)
SELECT DISTINCT
    ticker, name,
    ROUND(年初價, 2) as 年初價,
    ROUND(年末價, 2) as 年末價,
    ROUND((年末價 - 年初價) / 年初價 * 100, 2) as 年度報酬率
FROM first_last
ORDER BY 年度報酬率 DESC;
EOF
```

## 📚 進階應用場景

### 場景 1：回測投資策略
```sql
-- 模擬「低本益比策略」：每月買入本益比最低的前5檔
-- （這只是示範，實際回測需要更複雜的邏輯）
WITH monthly_pe AS (
    SELECT 
        strftime('%Y-%m', fetch_time) as 月份,
        ticker,
        name,
        AVG(pe) as 平均本益比,
        AVG(price) as 平均價格
    FROM stock_history
    WHERE pe > 0
    GROUP BY strftime('%Y-%m', fetch_time), ticker, name
)
SELECT 
    月份,
    ticker,
    name,
    ROUND(平均價格, 2) as 價格,
    ROUND(平均本益比, 2) as 本益比
FROM (
    SELECT *,
           ROW_NUMBER() OVER (PARTITION BY 月份 ORDER BY 平均本益比 ASC) as 排名
    FROM monthly_pe
)
WHERE 排名 <= 5
ORDER BY 月份, 排名;
```

### 場景 2：尋找突破股
```sql
-- 找出最近創新高的股票
WITH latest_high AS (
    SELECT 
        ticker,
        name,
        MAX(price) as 歷史最高價,
        (SELECT price FROM stock_history sh2 
         WHERE sh2.ticker = sh1.ticker 
         ORDER BY fetch_time DESC LIMIT 1) as 最新價
    FROM stock_history sh1
    GROUP BY ticker, name
)
SELECT 
    ticker,
    name,
    ROUND(最新價, 2) as 最新價,
    ROUND(歷史最高價, 2) as 歷史最高,
    ROUND((最新價 - 歷史最高價) / 歷史最高價 * 100, 2) as 距高點
FROM latest_high
WHERE 距高點 >= -5  -- 距離高點 5% 以內
ORDER BY 距高點 DESC;
```

### 場景 3：波動率分析（用於選擇權策略）
```sql
-- 計算 30 日歷史波動率（簡化版）
SELECT 
    ticker,
    name,
    ROUND(AVG(price), 2) as 平均價,
    ROUND((MAX(price) - MIN(price)) / AVG(price) * 100, 2) as 波動幅度,
    COUNT(*) as 樣本數
FROM stock_history
WHERE fetch_time >= date('now', '-30 days')
GROUP BY ticker, name
ORDER BY 波動幅度 DESC;
```

## 🎯 實用分析 Checklist

日常使用：
- [ ] 每天早上 9:00 自動更新（Launchd 已設定）
- [ ] 每週執行 `python3 query_stock.py` 查看趨勢
- [ ] 每月匯出 CSV 做深度分析

投資決策：
- [ ] 比較目標股票與產業平均
- [ ] 查看過去 3 個月價格趨勢
- [ ] 檢查本益比歷史分位數
- [ ] 分析 ROE 穩定性

策略回測：
- [ ] 定義選股條件（SQL 查詢）
- [ ] 匯出符合條件的股票清單
- [ ] 追蹤模擬組合表現

## 💡 小技巧

### 快速查詢模板
創建個人常用查詢的腳本：
```bash
# 創建 my_queries.sh
cat > my_queries.sh << 'EOF'
#!/bin/bash

echo "📊 我的股票監控列表"
sqlite3 stock_history.db << 'SQL'
SELECT ticker, name, price, pe, roe
FROM stock_history
WHERE ticker IN ('2480', '6214', '5203')
  AND date(fetch_time) = (SELECT MAX(date(fetch_time)) FROM stock_history);
SQL
EOF

chmod +x my_queries.sh
```

### 定期備份資料庫
```bash
# 加入每週備份
cp stock_history.db "backups/stock_$(date +%Y%m%d).db"
```

### 視覺化建議
使用 Excel/Numbers/Google Sheets：
1. 匯出 CSV
2. 建立折線圖（價格走勢）
3. 建立散點圖（PE vs ROE）
4. 建立相關性分析

或使用 Python：
```bash
pip3 install matplotlib pandas
# 然後可以用 Python 讀取 SQLite 畫圖
```

## 📞 命令速查

```bash
# === 資料查詢 ===
python3 query_stock.py              # 互動式查詢
sqlite3 stock_history.db            # 直接 SQL

# === 資料匯出 ===
python3 query_stock.py              # 選項 5（匯出 CSV）
sqlite3 -csv stock_history.db "..." # 命令列匯出

# === 系統管理 ===
make sync                               # 同步持股資料
make export                             # 匯出歷史 JSON

# === 資料庫管理 ===
sqlite3 stock_history.db ".tables"  # 查看表格
sqlite3 stock_history.db ".schema"  # 查看結構
du -h stock_history.db              # 查看大小
```

## 🎓 學習資源

### SQL 進階查詢
- Window Functions: `OVER()`, `ROW_NUMBER()`, `LAG()`, `LEAD()`
- CTEs (Common Table Expressions): `WITH ... AS`
- 聚合函數: `AVG()`, `MAX()`, `MIN()`, `COUNT()`, `SUM()`

### 投資分析指標
- **本益比 (PE)**: 價格 ÷ EPS（< 15 通常合理）
- **股價淨值比 (PB)**: 價格 ÷ 每股淨值（< 1.5 偏低估）
- **ROE**: 股東權益報酬率（> 15% 優秀）
- **殖利率**: 股利 ÷ 價格（> 4% 高殖利率）

---

**現在您擁有完整的一年歷史資料！** 🎉

使用 `python3 query_stock.py` 開始探索吧！
